# 高效率五官修復流程對比與優化

> 針對 832x1216 全身照五官修復的效率優化方案
> 
> 作者: Boy | 更新日期: 2025-11-11

---

## 目錄

1. [問題分析](#問題分析)
2. [流程方案對比](#流程方案對比)
3. [最優方案推薦](#最優方案推薦)
4. [實戰參數配置](#實戰參數配置)
5. [效率優化技巧](#效率優化技巧)

---

## 問題分析

### 全身照五官問題根源

```
832x1216 全身照
    ↓
人物佔比 60-70% → 實際身高約 850px
    ↓
頭部約 120px (身高的 1/7)
    ↓
臉部約 80x100px ← 太小!模型無法生成細節
    ↓
手部約 30x40px ← 更小!幾乎無法正確生成
```

**結論**: 不是模型能力問題,是**分辨率不足**問題。

### 你目前的兩個方案

#### 方案 A: 832x1216 → 一次採樣 → 2x放大 → 局部重繪

```
時間線:
1. 一次採樣 (832x1216)      : ~25秒
2. 2x Upscale (1664x2432)    : ~8秒
3. FaceDetailer              : ~15秒/張臉
   總計: ~48秒 (單人)
```

#### 方案 B: 832x1216 → 一次採樣 → 2x放大 → 二次採樣 → 局部重繪

```
時間線:
1. 一次採樣 (832x1216)      : ~25秒
2. 2x Upscale (1664x2432)    : ~8秒
3. 二次採樣 (1664x2432)      : ~35秒 (Refiner/Hi-res fix)
4. FaceDetailer              : ~15秒/張臉
   總計: ~83秒 (單人)
```

---

## 流程方案對比

### 完整方案列表

| 方案 | 流程 | 總時間<br>(單人) | 品質 | 效率 | 推薦度 |
|------|------|----------|------|------|--------|
| **A** | 一採樣 → 放大 → 局部重繪 | ~48秒 | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ |
| **B** | 一採樣 → 放大 → 二採樣 → 局部重繪 | ~83秒 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐ |
| **C** | 一採樣 → 二採樣 → 放大 → 局部重繪 | ~75秒 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| **D** | 較高解析度一採樣 → 局部重繪 | ~60秒 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| **E** | Latent 放大 → 一採樣 → 局部重繪 | ~45秒 | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |

### 方案 A: 你目前使用 (基準線)

```
┌─────────────────────────────────────────────────────────┐
│ 832x1216 一次採樣 (28 steps)          → 25秒           │
│         ↓                                                │
│ 2x Upscale (1664x2432)                 → 8秒            │
│         ↓                                                │
│ FaceDetailer (guide_size: 512)         → 15秒           │
│         ↓                                                │
│ 結果: 1664x2432 最終圖                                  │
└─────────────────────────────────────────────────────────┘
總時間: 48秒
```

**優點**:
- ✅ 流程簡單
- ✅ 速度快
- ✅ FaceDetailer 效果好 (因為放大後臉部約 160x200px)

**缺點**:
- ❌ 放大前小臉細節不足
- ❌ Upscale 可能產生瑕疵
- ❌ 整體質感略遜於二次採樣

### 方案 B: 你考慮的方案 (不推薦)

```
┌─────────────────────────────────────────────────────────┐
│ 832x1216 一次採樣 (28 steps)          → 25秒           │
│         ↓                                                │
│ 2x Upscale (1664x2432)                 → 8秒            │
│         ↓                                                │
│ 1664x2432 二次採樣 (10 steps, 0.4 denoise) → 35秒     │
│         ↓                                                │
│ FaceDetailer (guide_size: 512)         → 15秒           │
│         ↓                                                │
│ 結果: 1664x2432 最終圖                                  │
└─────────────────────────────────────────────────────────┘
總時間: 83秒
```

**問題分析**:

❌ **順序不當**: 放大後再二次採樣效率低
- 1664x2432 的二次採樣需要 4x 計算量 (vs 832x1216)
- 放大後的圖已經有瑕疵,二次採樣難以完全修正

❌ **重複工作**: 
- Upscale 已經嘗試重建細節
- 二次採樣又重新處理整張圖
- FaceDetailer 再次處理臉部
- 三次處理同一個區域,浪費算力

**建議**: 不要使用此流程

### 方案 C: 優化順序 ⭐推薦

```
┌─────────────────────────────────────────────────────────┐
│ 832x1216 一次採樣 (Base, 20 steps)    → 20秒           │
│         ↓                                                │
│ 832x1216 二次採樣 (Refiner, 10 steps) → 10秒           │
│         ↓                                                │
│ 2x Upscale (1664x2432)                 → 8秒            │
│         ↓                                                │
│ FaceDetailer (guide_size: 512)         → 15秒           │
│         ↓                                                │
│ 結果: 1664x2432 最終圖                                  │
└─────────────────────────────────────────────────────────┘
總時間: 53秒 (比方案A +5秒,比方案B -30秒)
```

**優勢分析**:

✅ **順序合理**:
1. 小圖二次採樣 (832x1216) - 計算量小,速度快
2. 二次採樣後質量提升,Upscale 效果更好
3. 最後 FaceDetailer 在良好基礎上精修

✅ **效率提升**:
- 832x1216 二次採樣只需 10秒 (vs 1664x2432 的 35秒)
- 節省 25秒,只增加 5秒總時間

✅ **品質提升**:
- 二次採樣改善小臉細節
- Upscale 基礎更好,瑕疵更少
- FaceDetailer 工作更輕鬆

### 方案 D: 較高解析度一次生成 ⭐⭐推薦

```
┌─────────────────────────────────────────────────────────┐
│ 1024x1536 一次採樣 (28 steps)         → 35秒           │
│         ↓                                                │
│ FaceDetailer (guide_size: 512)         → 15秒           │
│         ↓                                                │
│ (可選) 1.5x Upscale → 1536x2304       → 6秒            │
│         ↓                                                │
│ 結果: 1024x1536 或 1536x2304                            │
└─────────────────────────────────────────────────────────┘
總時間: 50秒 (不放大) 或 56秒 (放大)
```

**關鍵優勢**:

✅ **一步到位**:
- 1024x1536 生成時臉部約 120x150px
- 已經足夠模型生成基本五官細節
- 減少後期修復需求

✅ **VRAM 友善**:
- RTX 5080 64GB RAM 完全可以處理
- 1024x1536 比 1664x2432 節省大量 VRAM

✅ **流程簡潔**:
- 減少一個 Upscale 步驟
- 減少瑕疵累積機會

**配置建議**:

```
Resolution: 1024x1536 (或 1088x1600)
Steps: 28-32
CFG: 7
Sampler: DPM++ 2M Karras
```

**何時放大**:
- 如需印刷/高解析度 → 1.5x Upscale
- 僅網路分享 → 1024x1536 已足夠

### 方案 E: Latent Upscale ⭐⭐⭐最推薦

```
┌─────────────────────────────────────────────────────────┐
│ Empty Latent: 832x1216                 → 0秒            │
│         ↓                                                │
│ Latent Upscale 1.5x → 1248x1824       → <1秒 (latent)  │
│         ↓                                                │
│ KSampler (28 steps, denoise: 0.6)     → 40秒           │
│         ↓                                                │
│ FaceDetailer (guide_size: 512)         → 15秒           │
│         ↓                                                │
│ 結果: 1248x1824 最終圖                                  │
└─────────────────────────────────────────────────────────┘
總時間: 56秒
```

**核心技術**: Latent Upscale + Hi-res Fix

```
工作原理:
1. 在 latent space 放大 (極快,<1秒)
2. 較低 denoise (0.5-0.6) 採樣
3. 模型在更高解析度下生成細節
4. 相當於"原生"高解析度生成

優勢:
• 比直接生成 1248x1824 快 (denoise <1.0)
• 比先生成再放大品質好
• 臉部約 150x180px,細節充足
```

**節點配置**:

```
[Empty Latent Image]
  width: 832
  height: 1216
  batch_size: 1
    ↓
[LatentUpscale]
  upscale_method: nearest-exact (或 bilinear)
  width: 1248 (832 * 1.5)
  height: 1824 (1216 * 1.5)
  crop: disabled
    ↓
[KSampler]
  steps: 28
  cfg: 7
  denoise: 0.55-0.65  ← 關鍵!
    ↓
[VAE Decode]
    ↓
[FaceDetailer]
```

**denoise 參數選擇**:

```
denoise: 0.5   → 輕微改善,保留 latent upscale 結果
denoise: 0.6   → 平衡,推薦值
denoise: 0.7   → 較大改動,接近重新生成
denoise: 0.8+  → 幾乎重新生成,可能改變構圖
```

---

## 最優方案推薦

### 根據需求選擇

#### 情境 1: 最快速度 (追求效率)

```
✅ 方案 A (改良版)
832x1216 → 一次採樣 → 2x Upscale → FaceDetailer
時間: 48秒
品質: ⭐⭐⭐⭐

改良建議:
• 提高一次採樣 steps (28 → 32)
• 使用更好的 Upscaler (4x-UltraSharp)
• FaceDetailer denoise 提高到 0.4
```

#### 情境 2: 平衡速度與品質 ⭐⭐推薦

```
✅ 方案 E: Latent Upscale
832x1216 → Latent 1.5x → 採樣 (denoise 0.6) → FaceDetailer
時間: 56秒
品質: ⭐⭐⭐⭐⭐

為什麼推薦:
• 只比方案A慢8秒
• 品質顯著提升
• 流程優雅,減少瑕疵累積
• 適合批量生產
```

#### 情境 3: 最高品質 (不在乎時間)

```
✅ 方案 C + 加強版
832x1216 → Base (22步) → Refiner (10步) → 2x Upscale → FaceDetailer → (可選)HandDetailer
時間: 68秒 (含手部修復)
品質: ⭐⭐⭐⭐⭐

適用:
• 精品圖生成
• 需要完美五官和手部
• 商業用途
```

### 我對你的建議

```
📌 推薦: 方案 E (Latent Upscale)

理由:
1. 你已經熟悉流程,改動小
2. 效率提升明顯 (56秒 vs 83秒)
3. 品質提升顯著
4. 適合單人和多人場景
5. RTX 5080 算力完全足夠

實施:
1. 保留現有 workflow
2. 在一次採樣前加入 LatentUpscale 節點
3. 設定 denoise: 0.6
4. 移除放大後的二次採樣
```

---

## 實戰參數配置

### 方案 E 完整節點配置

#### 1. Base 生成部分

```
[Empty Latent Image]
  width: 832
  height: 1216
  batch_size: 1

↓

[LatentUpscale]
  upscale_method: nearest-exact
  width: 1248
  height: 1824
  crop: disabled

↓

[PCLazyTextEncode] (Positive)
  text: <你的多人提示詞>
  
[PCLazyTextEncode] (Negative)
  text: <負面提示詞>

↓

[KSampler]
  seed: (隨機或固定)
  steps: 28
  cfg: 7
  sampler_name: dpm_2m_karras
  scheduler: karras
  denoise: 0.6  ← 關鍵參數!
  
↓

[VAE Decode]
```

#### 2. FaceDetailer 部分

```
[Image from VAE] → [FaceDetailer]

[FaceDetailer] 設定:
  guide_size: 512
  guide_size_for: bbox  
  max_size: 1024
  seed: (same as main)
  steps: 20
  cfg: 7
  sampler_name: dpm_2m_karras
  scheduler: karras
  denoise: 0.35  ← 因為 base 已經好,輕度修復即可
  feather: 20
  crop_factor: 1.5
  
[BBOX Detector]
  model_name: bbox/face_yolov8n.pt
  threshold: 0.5
  dilation: 10

[SAM Detector]  
  model_name: sam_vit_b_01ec64.pth
  device_mode: AUTO
```

#### 3. 提示詞配置

```
Positive (Main):
masterpiece, best quality, highly detailed, 1girl, full body, 
red dress, long black hair, standing, park background, 
detailed face, beautiful eyes

Positive (FaceDetailer):
masterpiece, best quality, highly detailed face, detailed eyes,
detailed skin, perfect face, beautiful lighting, sharp focus

Negative (Main):
lowres, bad anatomy, bad hands, bad face, missing fingers,
extra digit, fewer digits, cropped, worst quality

Negative (FaceDetailer):  
lowres, bad face, deformed face, ugly, bad proportions,
bad eyes, blurry face
```

### denoise 值調整指南

#### Main KSampler (Latent Upscale 後)

| denoise | 效果 | 適用情況 | 品質 | 速度 |
|---------|------|----------|------|------|
| 0.50 | 輕微增強細節 | Latent 結果已經很好 | ⭐⭐⭐ | 最快 |
| 0.55 | 溫和改善 | 一般情況 | ⭐⭐⭐⭐ | 快 |
| **0.60** | **平衡推薦** | **大多數情況** | **⭐⭐⭐⭐** | **中** |
| 0.65 | 較大改動 | 需要更多細節 | ⭐⭐⭐⭐⭐ | 中慢 |
| 0.70 | 接近重生成 | 構圖需要調整 | ⭐⭐⭐⭐⭐ | 慢 |

#### FaceDetailer denoise

| denoise | 效果 | 適用情況 | 建議 |
|---------|------|----------|------|
| 0.25 | 最小修改 | Base 臉部已經很好 | 保守 |
| **0.35** | **輕度修復** | **推薦起點** | **⭐推薦** |
| 0.40 | 標準修復 | 一般五官問題 | 常用 |
| 0.45 | 較強修復 | 五官較模糊 | 需要 |
| 0.50 | 強力修復 | 五官崩壞 | 謹慎 |

**決策樹**:

```
Base 臉部品質評估:
    ↓
清晰但缺細節? → FaceDetailer denoise: 0.3
    ↓
五官可見但模糊? → FaceDetailer denoise: 0.35-0.4
    ↓
五官不清楚? → FaceDetailer denoise: 0.45
    ↓
五官崩壞? → FaceDetailer denoise: 0.5 (或重新生成)
```

### 多人場景配置差異

#### 2人場景

```
[LatentUpscale]
  width: 1248
  height: 1824
  
[KSampler]
  denoise: 0.60  (標準)
  
[FaceDetailer]
  guide_size: 512
  denoise: 0.35
  
  # 會自動偵測並處理兩張臉
  # 每張臉 15秒 → 總共 30秒
```

#### 3-4人場景

```
[LatentUpscale]
  width: 1248 (或 1664 if needed)
  height: 1824 (或 2432)
  
[KSampler]
  denoise: 0.65  (提高,因為人多細節更難)
  
[FaceDetailer]
  guide_size: 512
  denoise: 0.40  (提高,因為小臉更多)
  bbox_threshold: 0.4  (降低,確保偵測小臉)
  
  # 4張臉 × 15秒 = 60秒
```

---

## 效率優化技巧

### 技巧 1: 批次處理優化

```
# 如果你需要生成多張變體
[KSampler]
  batch_size: 4  ← 一次生成4張
  
# VRAM 需求:
單張: ~8GB
4張: ~24GB  ← 你的 64GB 完全足夠!

# 時間對比:
單張生成 4次: 56秒 × 4 = 224秒
批次生成 4張: ~90秒

節省: 134秒 (60%)
```

### 技巧 2: 選擇性使用 FaceDetailer

```
# 添加 Bypass 開關
[FaceDetailer] 
  ↓
只在需要時啟用:
• 五官清晰 → Bypass (節省 15秒)
• 五官模糊 → Enable

# 實際使用:
生成 10張圖 → 挑選最佳 2-3張 → FaceDetailer
而非: 10張全部 FaceDetailer
```

### 技巧 3: 智能 Upscale 選擇

```
目標用途決定是否 Upscale:

社群媒體 (IG/Twitter):
  1248x1824 → 不再 Upscale ✅
  (IG 壓縮後看不出差異)

印刷/高解析度:
  1248x1824 → 1.5x Upscale → 1872x2736 ✅

專業用途:
  1248x1824 → 2x Upscale → 2496x3648 ✅
```

### 技巧 4: Guide Size 最佳化

```
FaceDetailer guide_size 選擇:

快速預覽: guide_size: 384  (~10秒/臉)
標準品質: guide_size: 512  (~15秒/臉) ← 推薦
最高品質: guide_size: 768  (~25秒/臉)

建議流程:
1. 初次生成用 384 快速檢查
2. 滿意後用 512 最終輸出
```

### 技巧 5: 階段性檢查點

```
工作流程中加入預覽節點:

[KSampler] → [Preview Image] ← 檢查構圖
     ↓
[VAE Decode] → [Preview Image] ← 檢查基礎品質  
     ↓
[FaceDetailer] → [Preview Image] ← 檢查修復效果
     ↓
[Save Image]

好處:
• 早期發現問題,避免浪費後續處理
• 可以在任一階段停止並重新調整
```

### 技巧 6: LoRA 權重優化

```
# 在 Latent Upscale 流程中調整 LoRA 權重

角色 LoRA 權重排程:
<lora:character:[1.0:0.55:0.3]>
                    ↑
            降低結束權重 (0.6 → 0.55)
            因為更高解析度 + denoise 0.6
            可以讓模型更自由發揮

細節 LoRA:
<lora:detail:[0.4:0.7:0.5]>
            ↑
    後期權重可以稍高,利用高解析度
```

### 技巧 7: 手部處理策略

```
手部問題判斷:

Base 生成後檢查手部:
  ↓
手部基本正確 → 只用 FaceDetailer (節省 15-20秒)
  ↓
手部有問題 → 加入 HandDetailer

# HandDetailer 參數
denoise: 0.45-0.55  (比 Face 高)
guide_size: 512
prompt: detailed hands, perfect fingers, 5 fingers

注意: 手部修復成功率 < 臉部,可能需要多次嘗試
```

---

## 時間與品質對比總表

### 完整流程比較 (單人全身照)

| 方案 | Base 解析度 | 最終解析度 | 總時間 | 品質評分 | 效率評分 | 推薦度 |
|------|-------------|------------|--------|----------|----------|--------|
| A (原方案) | 832x1216 | 1664x2432 | 48秒 | 8.0/10 | 9.5/10 | ⭐⭐⭐⭐ |
| B (不推薦) | 832x1216 | 1664x2432 | 83秒 | 8.5/10 | 6.0/10 | ⭐⭐ |
| C (優化順序) | 832x1216 | 1664x2432 | 53秒 | 9.0/10 | 9.0/10 | ⭐⭐⭐⭐ |
| D (高解析度) | 1024x1536 | 1536x2304 | 56秒 | 9.0/10 | 8.5/10 | ⭐⭐⭐⭐ |
| **E (Latent)** | **832→1248x1824** | **1248x1824** | **56秒** | **9.5/10** | **9.5/10** | **⭐⭐⭐⭐⭐** |

### 多人場景時間預估

| 人數 | 方案 A | 方案 E (推薦) | 說明 |
|------|--------|---------------|------|
| 1人 | 48秒 | 56秒 | Base +8秒,但品質更好 |
| 2人 | 78秒 | 86秒 | +30秒 (2張臉) |
| 3人 | 108秒 | 116秒 | +45秒 (3張臉) |
| 4人 | 138秒 | 146秒 | +60秒 (4張臉) |

**結論**: 方案 E 雖然每次多 8秒,但品質提升值得投資。

---

## 實施建議

### Step 1: 測試方案 E

```
1. 備份現有 workflow
2. 在現有基礎上添加 LatentUpscale 節點
3. 設定 denoise: 0.6
4. 測試 5-10 張圖
5. 對比方案 A 的結果
```

### Step 2: 調整參數

```
根據測試結果微調:

如果細節不足:
  → 提高 denoise (0.6 → 0.65)
  → 提高 FaceDetailer denoise (0.35 → 0.4)

如果改變太多:
  → 降低 denoise (0.6 → 0.55)
  → 降低 FaceDetailer denoise (0.35 → 0.3)
```

### Step 3: 建立標準流程

```
為不同場景建立預設:

single_person.json
  - Latent: 832 → 1248x1824
  - denoise: 0.6
  - FaceDetailer: 0.35

two_person.json
  - Latent: 832 → 1248x1824
  - denoise: 0.65
  - FaceDetailer: 0.4

four_person.json
  - Latent: 832 → 1664x2432 (更高解析度)
  - denoise: 0.70
  - FaceDetailer: 0.45
```

### Step 4: 長期優化

```
收集數據:
  • 記錄每種場景的最佳參數
  • 追蹤成功率
  • 優化瓶頸環節

持續改進:
  • 測試新的 Upscaler
  • 嘗試不同 denoise 組合
  • 微調 LoRA 權重
```

---

## 結論

### 最終推薦: 方案 E (Latent Upscale)

```
✅ 為什麼選這個:

1. 效率優秀: 56秒 vs 83秒 (節省 27秒)
2. 品質提升: 高解析度原生生成
3. 流程優雅: 減少瑕疵累積
4. 適應性強: 單人/多人都適用
5. 硬體友善: RTX 5080 輕鬆應對
6. 易於實施: 小改動即可升級
```

### 核心參數記憶卡

```
📋 記住這組參數:

LatentUpscale: 832x1216 → 1248x1824 (1.5x)
Main denoise: 0.60
FaceDetailer denoise: 0.35
Guide size: 512
Steps: 28

這組參數適用於 80% 的場景!
```

### 特殊情況處理

```
小臉太多 (4人+):
  → 提高 Latent 到 1664x2432
  → Main denoise: 0.65
  → FaceDetailer: 0.4

追求極速:
  → 保留方案 A
  → 提高 Main steps 到 32
  → 使用更好的 Upscaler

追求極品質:
  → 方案 C (加二次採樣)
  → 加入 HandDetailer
  → 可選 2x 最終 Upscale
```

---

**最後提醒**: 不要過度追求完美,80分的結果用 50秒,90分的結果用 150秒。根據用途選擇合適的流程!