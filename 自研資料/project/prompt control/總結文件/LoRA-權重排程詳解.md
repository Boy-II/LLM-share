# LoRA 權重排程詳解 - Prompt Control 進階技巧

> 深入解析 `[起始權重:結束權重:切換時間點]` 語法及最佳實踐
> 
> 作者: Boy | 更新日期: 2025-11-11

---

## 目錄

1. [基礎語法說明](#基礎語法說明)
2. [擴散過程原理](#擴散過程原理)
3. [權重排程策略](#權重排程策略)
4. [實戰應用場景](#實戰應用場景)
5. [多人場景優化](#多人場景優化)
6. [常見錯誤與解決](#常見錯誤與解決)

---

## 基礎語法說明

### 標準語法格式

```
<lora:名稱:[起始權重:結束權重:切換時間點]>
```

### 參數解析

| 參數 | 範圍 | 說明 |
|------|------|------|
| 起始權重 | 0.0-2.0 | 生成開始時的 LoRA 影響力 |
| 結束權重 | 0.0-2.0 | 生成結束時的 LoRA 影響力 |
| 切換時間點 | 0.0-1.0 | 權重變化的時間點 (百分比) |

### 基礎範例

```
<lora:character:0.8>              # 固定權重 0.8
<lora:character:[1.0:0.5:0.3]>    # 從 1.0 降到 0.5,在 30% 時切換
<lora:character:[0.5:1.0:0.5]>    # 從 0.5 升到 1.0,在 50% 時切換
<lora:character:[1.0:0:0.7]>      # 從 1.0 降到 0,在 70% 時停用
```

---

## 擴散過程原理

### Stable Diffusion 生成階段

SD/SDXL 的生成過程可以分為三個主要階段:

```
0% ────────── 30% ────────── 70% ────────── 100%
│              │               │               │
初期階段      中期階段        後期階段       完成
(構圖)       (細節)         (精修)
```

#### 各階段特性

| 階段 | 時間範圍 | 主要作用 | LoRA 影響 |
|------|----------|----------|-----------|
| **初期** | 0-30% | 確定整體構圖、位置、姿勢 | **影響最大** - 決定基本結構 |
| **中期** | 30-70% | 填充細節、服裝、髮型、表情 | **影響中等** - 細化特徵 |
| **後期** | 70-100% | 精修質感、光影、邊緣處理 | **影響較小** - 微調品質 |

### 權重影響力曲線

```
LoRA 影響力
    │
1.0 │ ████████████╲
    │              ╲╲
0.7 │                ╲╲
    │                  ╲╲___________
0.3 │                              
    │
0.0 └─────────────────────────────────> 生成進度
    0%        30%         70%      100%

初期高權重確保構圖,後期降低避免過擬合
```

---

## 權重排程策略

### 策略 1: 前期強化 (推薦用於角色 LoRA)

#### 語法
```
<lora:character:[1.0:0.6:0.3]>
```

#### 時間軸
```
0%           30%                    100%
├─────────────┼───────────────────────┤
│  權重 1.0   │      權重 0.6        │
└─────────────┴───────────────────────┘
  構圖確立期      細節完善期
```

#### 適用情境
- **角色 LoRA**: 需要在初期確立角色外觀特徵
- **姿勢 LoRA**: 早期確定動作和構圖
- **風格 LoRA**: 整體畫風需要從一開始就明確

#### 實際範例

```
# 確保角色特徵在構圖階段就明確
ATTN() <lora:asuna:[1.0:0.6:0.3]> 1girl, asuna \(sao\), orange hair, KoB uniform MASK(0 0.45, 0 1)
```

**為什麼這樣設定**:
- `1.0 (0-30%)`: 初期高權重確保角色的基本外觀、髮型、服裝在構圖階段就被確立
- `0.6 (30-100%)`: 降低權重讓模型有更多自由度處理細節,避免過度擬合導致僵硬
- `0.3 切換點`: 在構圖確立後切換,給足夠時間建立角色特徵

### 策略 2: 後期強化 (推薦用於細節 LoRA)

#### 語法
```
<lora:detail_enhancer:[0.4:0.8:0.5]>
```

#### 時間軸
```
0%                50%              100%
├─────────────────┼─────────────────┤
│   權重 0.4      │    權重 0.8     │
└─────────────────┴─────────────────┘
  基礎構圖         細節強化期
```

#### 適用情境
- **細節增強 LoRA**: 服裝紋理、材質細節
- **光影 LoRA**: 後期加強光影效果
- **品質提升 LoRA**: 最後階段提升整體質感

#### 實際範例

```
# 後期強化細節和質感
<lora:detail_plus:[0.3:0.7:0.6]> masterpiece, highly detailed, intricate details
```

**為什麼這樣設定**:
- `0.3 (0-60%)`: 前期低權重避免過早干擾構圖和基本形態
- `0.7 (60-100%)`: 後期提高權重加強細節和質感
- `0.6 切換點`: 在基本構圖和形態確立後才開始強化細節

### 策略 3: 中期峰值 (推薦用於特殊效果)

#### 語法
```
<lora:special_effect:[0.5:0.8:0.3]> → [0.8:0.5:0.7]>
```

#### 時間軸
```
0%        30%           70%        100%
├──────────┼──────────────┼──────────┤
│ 權重 0.5 │  權重 0.8    │ 權重 0.5 │
└──────────┴──────────────┴──────────┘
  低影響     高峰期        回落期
```

#### 適用情境
- **特殊姿勢**: 需要在中期確立但不希望過度影響最終精修
- **複雜服裝**: 中期強化服裝結構,後期讓模型自然處理細節
- **背景元素**: 需要控制但不希望壓過主體

#### 實際範例

```
# 需要兩段排程組合實現
<lora:complex_outfit:[0.5:0.9:0.3]> 前 70%
# 配合下一個 sampler 或使用 img2img
<lora:complex_outfit:[0.9:0.5:0.3]> 後 30%
```

### 策略 4: 漸進淡出 (推薦用於避免過擬合)

#### 語法
```
<lora:character:[1.0:0:0.5]>
```

#### 時間軸
```
0%                  50%              100%
├────────────────────┼─────────────────┤
│    權重 1.0        │    權重 0       │
└────────────────────┴─────────────────┘
  LoRA 作用期          完全停用
```

#### 適用情境
- **訓練不佳的 LoRA**: 容易過擬合或產生瑕疵
- **測試階段**: 觀察 LoRA 只在前半段作用的效果
- **混合生成**: 前半段用 LoRA,後半段讓基礎模型自由發揮

#### 實際範例

```
# 初期確立特徵後完全停用
<lora:experimental_char:[0.8:0:0.4]> 1girl, unique style
```

**為什麼這樣設定**:
- `0.8 (0-40%)`: 前 40% 用中高權重確立基本特徵
- `0 (40-100%)`: 完全停用,讓基礎模型接手完成細節
- `0.4 切換點`: 較早切換,給基礎模型更多時間自然發揮

### 策略 5: 雙階段強化 (需要多次排程)

#### 語法 (概念示意)
```
# 實際需要分段實現或使用 img2img workflow
前期: <lora:char:[1.0:0.5:0.2]>
後期: <lora:char:[0.5:0.9:0.8]>
```

#### 時間軸
```
0%    20%         80%          100%
├──────┼───────────┼─────────────┤
│ 1.0  │    0.5    │    0.9      │
└──────┴───────────┴─────────────┘
初期強化  中期弱化   後期再強化
```

#### 適用情境
- **複雜場景**: 需要多階段控制
- **多 LoRA 協調**: 不同階段側重不同 LoRA
- **高品質需求**: 精細控制每個階段

---

## 實戰應用場景

### 場景 1: 角色外觀確立 (最常用)

#### 目標
確保角色的髮型、服裝、臉部特徵在初期就被正確生成

#### 推薦設定
```
<lora:character_A:[1.0:0.6:0.3]>
```

#### 完整範例
```
ATTN() <lora:rem:[1.0:0.6:0.3]> 1girl, rem \(re:zero\), maid outfit, blue hair, hair clip, left side MASK(0 0.45, 0 1)
```

#### 參數說明
- **1.0 起始**: 最高權重確保角色特徵被捕捉
- **0.6 結束**: 適度降低避免過擬合,保持自然感
- **0.3 切換**: 在構圖階段完成 (約 8-10 steps @ 28 steps)

#### 效果預期
- ✅ 角色特徵明確
- ✅ 髮型、服裝正確
- ✅ 細節自然不僵硬

### 場景 2: 風格控制

#### 目標
整體畫風統一,但不壓過角色特徵

#### 推薦設定
```
<lora:anime_style:[0.5:0.7:0.4]>
```

#### 完整範例
```
<lora:watercolor_style:[0.5:0.7:0.4]> masterpiece, best quality, soft colors, gentle lighting BREAK
ATTN() <lora:character_A:[1.0:0.6:0.3]> 1girl, red dress MASK(0 0.45, 0 1)
```

#### 參數說明
- **0.5 起始**: 初期較低,不干擾角色構圖
- **0.7 結束**: 後期提高,強化整體風格
- **0.4 切換**: 在角色基本確立後才增強風格

#### LoRA 順序
```
風格 LoRA (後期強化) → 角色 LoRA (前期強化)
```

### 場景 3: 服裝細節控制

#### 目標
確保服裝款式正確,但保持自然褶皺和光影

#### 推薦設定
```
<lora:dress_detail:[0.7:0.9:0.5]>
```

#### 完整範例
```
ATTN() <lora:character:[1.0:0.6:0.3]> <lora:wedding_dress:[0.7:0.9:0.5]> 1girl, character_name, white wedding dress, veil, lace details MASK(0 0.45, 0 1)
```

#### 參數說明
- **0.7 起始**: 中期開始作用,避免與角色 LoRA 衝突
- **0.9 結束**: 高權重確保服裝細節豐富
- **0.5 切換**: 中期切換,在基本形態後加強細節

#### 多 LoRA 時間軸
```
0%           30%          50%         100%
├─────────────┼────────────┼────────────┤
角色 1.0→0.6   角色 0.6     角色 0.6
               服裝 0.7     服裝 0.7→0.9
```

### 場景 4: 姿勢動作固定

#### 目標
確保特定姿勢或動作被正確生成

#### 推薦設定
```
<lora:pose_dancing:[1.0:0.5:0.25]>
```

#### 完整範例
```
ATTN() <lora:character:[1.0:0.6:0.3]> <lora:dancing_pose:[1.0:0.5:0.25]> 1girl, character_name, dancing, dynamic pose, arms raised MASK(0.3 0.7, 0 1)
```

#### 參數說明
- **1.0 起始**: 最高權重,姿勢需要在最初期確立
- **0.5 結束**: 大幅降低,避免姿勢僵硬
- **0.25 切換**: 非常早期切換 (約 7 steps @ 28 steps),只用於確立骨架

#### 為何這麼早切換?
- 姿勢屬於最基礎的構圖要素
- 過晚會導致動作不自然
- 早期確立後讓模型自然調整細節

### 場景 5: 背景元素控制

#### 目標
添加背景元素但不壓過主體角色

#### 推薦設定
```
<lora:background_city:[0.3:0.6:0.6]>
```

#### 完整範例
```
<lora:background_city:[0.3:0.6:0.6]> city street, buildings, traffic AND
ATTN() <lora:character:[1.0:0.6:0.3]> 1girl, character_name MASK(0.3 0.7, 0.3 1, 1.2)
```

#### 參數說明
- **0.3 起始**: 低權重,主體優先
- **0.6 結束**: 中等權重,背景清晰但不搶眼
- **0.6 切換**: 較晚切換,主體確立後才強化背景

#### 與角色 LoRA 協調
```
角色 LoRA: 高權重 → 中權重 (前期強化)
背景 LoRA: 低權重 → 中權重 (後期補充)
```

---

## 多人場景優化

### 2人場景: 平衡雙角色

#### 策略: 交錯峰值

```
# 角色A前期優先
ATTN() <lora:character_A:[1.0:0.7:0.3]> 1girl, char_A MASK(0 0.45, 0 1) AND
# 角色B後期強化
ATTN() <lora:character_B:[0.7:1.0:0.3]> 1girl, char_B MASK(0.55 1, 0 1)
```

#### 時間軸
```
0%              30%                    100%
├────────────────┼───────────────────────┤
角色A: 1.0 ──────→ 0.7 ────────────────→ 0.7
角色B: 0.7 ──────→ 1.0 ────────────────→ 1.0
```

#### 效果
- 初期角色A特徵優先建立
- 30% 後角色B開始強化
- 避免兩個角色同時高權重互相干擾

### 2人場景: 主從關係

#### 策略: 主角前期強化,配角後期補充

```
# 主角 (焦點)
ATTN() <lora:main_character:[1.0:0.7:0.3]> 1girl, main_char, detailed face MASK(0.3 0.7, 0.4 1, 1.3) AND
# 配角 (背景)
ATTN() <lora:side_character:[0.5:0.7:0.5]> 1girl, side_char, blurred MASK(0.1 0.4, 0.2 0.8, 0.7)
```

#### 參數對比
| 角色 | 起始 | 結束 | 切換點 | 策略 |
|------|------|------|--------|------|
| 主角 | 1.0 | 0.7 | 0.3 | 前期高權重確立 |
| 配角 | 0.5 | 0.7 | 0.5 | 中後期補充 |

### 3人場景: 分層漸進

#### 策略: 前→中→後依序確立

```
# 前景角色 - 最早確立
ATTN() <lora:char_front:[1.0:0.6:0.2]> 1girl, front, detailed MASK(...) AREA(..., 1.4) AND
# 中景角色 - 中期確立
ATTN() <lora:char_mid:[0.7:0.8:0.4]> 1girl, middle MASK(...) AREA(..., 1.0) AND
# 後景角色 - 後期補充
ATTN() <lora:char_back:[0.4:0.7:0.6]> 1girl, background, blurred MASK(...) AREA(..., 0.6)
```

#### 時間軸
```
0%      20%      40%      60%          100%
├────────┼────────┼────────┼─────────────┤
前: 1.0→0.6 ──────────────────────────→ 0.6
中:      0.7 ───→ 0.8 ──────────────────→ 0.8
後:               0.4 ────→ 0.7 ────────→ 0.7
```

#### 切換點選擇原因
- **前景 0.2**: 最重要,最早確立
- **中景 0.4**: 前景確立後才開始
- **後景 0.6**: 最晚確立,避免干擾前中景

### 4人場景: 分組策略

#### 策略A: 左右分組

```
# 左側組 (前期優先)
ATTN() <lora:char1:[1.0:0.6:0.3]> ... MASK(0 0.22, 0 1) AND
ATTN() <lora:char2:[0.9:0.6:0.3]> ... MASK(0.26 0.48, 0 1) AND
# 右側組 (後期強化)
ATTN() <lora:char3:[0.7:0.9:0.4]> ... MASK(0.52 0.74, 0 1) AND
ATTN() <lora:char4:[0.6:0.8:0.4]> ... MASK(0.78 1, 0 1)
```

#### 策略B: 焦點+背景

```
# 焦點角色 (前期高權重)
ATTN() <lora:main:[1.0:0.7:0.3]> 1girl, center, detailed MASK(0.3 0.7, 0.2 1, 1.5) AND
# 背景角色 (後期補充,權重相同)
ATTN() <lora:bg1:[0.5:0.6:0.5]> 1girl, left_bg MASK(0 0.3, 0.3 0.9, 0.6) AND
ATTN() <lora:bg2:[0.5:0.6:0.5]> 1girl, right_bg MASK(0.7 1, 0.3 0.9, 0.6) AND
ATTN() <lora:bg3:[0.5:0.6:0.5]> 1girl, back_bg MASK(0.4 0.6, 0 0.4, 0.5)
```

### 多人場景權重規則總結

#### 規則 1: 優先級原則
```
前景/主角: 1.0 起始,早切換 (0.2-0.3)
中景/配角: 0.7 起始,中切換 (0.4-0.5)
後景/群眾: 0.5 起始,晚切換 (0.6-0.7)
```

#### 規則 2: 避免同時峰值
```
# ❌ 錯誤 - 同時高權重
角色A: [1.0:0.6:0.3]
角色B: [1.0:0.6:0.3]

# ✅ 正確 - 交錯峰值
角色A: [1.0:0.7:0.3]
角色B: [0.7:1.0:0.3]
```

#### 規則 3: 權重總和控制
```
# 在任何時間點,所有角色權重總和建議 < 3.0
# 避免過度引導

例如 2 人:
角色A: 1.0 + 角色B: 0.7 = 1.7 ✅
角色A: 1.0 + 角色B: 1.0 = 2.0 ⚠️ (可能互相干擾)
角色A: 1.2 + 角色B: 1.2 = 2.4 ❌ (過度引導)
```

---

## 常見錯誤與解決

### 錯誤 1: 權重過高導致過擬合

#### 現象
```
<lora:character:[1.5:1.5:0.5]>
```
- 角色看起來僵硬、不自然
- 缺少細節變化
- 姿勢動作呆板

#### 解決方案
```
# 降低權重,加入衰減
<lora:character:[1.0:0.6:0.3]>
```

#### 權重安全範圍
- **角色 LoRA**: 0.6-1.0
- **風格 LoRA**: 0.3-0.7
- **細節 LoRA**: 0.4-0.8

### 錯誤 2: 切換點設置不當

#### 現象 A: 切換太早
```
<lora:character:[1.0:0.5:0.1]>
```
- 角色特徵不明確
- 容易產生錯誤特徵

#### 解決方案 A
```
<lora:character:[1.0:0.6:0.3]>
# 至少給 30% 時間確立特徵
```

#### 現象 B: 切換太晚
```
<lora:character:[1.0:0.5:0.8]>
```
- 後期細節處理不自然
- 過度擬合時間太長

#### 解決方案 B
```
<lora:character:[1.0:0.6:0.4]>
# 留 60% 時間給模型自然發揮
```

### 錯誤 3: 多 LoRA 衝突

#### 現象
```
<lora:charA:[1.0:0.8:0.3]>
<lora:charB:[1.0:0.8:0.3]>
# 同時高權重,互相干擾
```

#### 解決方案
```
# 交錯峰值
<lora:charA:[1.0:0.7:0.3]>
<lora:charB:[0.7:1.0:0.3]>

# 或分層
<lora:charA:[1.0:0.6:0.2]>  # 早期確立
<lora:charB:[0.6:0.9:0.5]>  # 後期強化
```

### 錯誤 4: 忽略結束權重

#### 現象
```
<lora:character:[1.0:1.0:0.5]>
# 始終高權重,後期過度干預
```

#### 解決方案
```
<lora:character:[1.0:0.6:0.3]>
# 後期降低權重,給模型自由度
```

#### 結束權重建議
- **需要精確控制**: 0.7-0.8
- **一般情況**: 0.6-0.7
- **自然發揮**: 0.5-0.6
- **測試用**: 0.3-0.4

### 錯誤 5: 所有 LoRA 用同樣排程

#### 現象
```
<lora:character:[1.0:0.6:0.3]>
<lora:style:[1.0:0.6:0.3]>
<lora:detail:[1.0:0.6:0.3]>
# 沒有考慮不同 LoRA 的作用階段
```

#### 解決方案
```
<lora:character:[1.0:0.6:0.3]>    # 前期確立
<lora:style:[0.5:0.7:0.4]>        # 中後期增強
<lora:detail:[0.3:0.6:0.6]>       # 後期精修
```

---

## 切換點選擇指南

### 快速參考表

| LoRA 類型 | 推薦起始 | 推薦結束 | 推薦切換點 | 原因 |
|-----------|----------|----------|------------|------|
| 角色外觀 | 1.0 | 0.6-0.7 | 0.3 | 早期確立特徵 |
| 角色姿勢 | 1.0 | 0.4-0.5 | 0.2-0.25 | 最早確立骨架 |
| 服裝細節 | 0.7 | 0.8-0.9 | 0.5 | 中期加強 |
| 整體風格 | 0.4-0.5 | 0.6-0.7 | 0.4-0.5 | 後期統一 |
| 背景元素 | 0.3-0.4 | 0.5-0.6 | 0.6 | 最後補充 |
| 光影效果 | 0.3 | 0.6-0.7 | 0.7 | 最後精修 |
| 品質增強 | 0.3-0.4 | 0.6-0.7 | 0.6-0.7 | 最後階段 |

### 步數對應 (基於 28 Steps)

| 切換點 | 對應步數 | 階段 | 適用 LoRA |
|--------|----------|------|-----------|
| 0.1 | ~3 步 | 超早期 | 測試用 |
| 0.2 | ~6 步 | 早期 | 姿勢 LoRA |
| 0.3 | ~8 步 | 構圖期 | 角色 LoRA (標準) |
| 0.4 | ~11 步 | 中前期 | 風格 LoRA |
| 0.5 | ~14 步 | 中期 | 服裝細節 LoRA |
| 0.6 | ~17 步 | 中後期 | 背景 LoRA |
| 0.7 | ~20 步 | 後期 | 光影 LoRA |
| 0.8 | ~22 步 | 精修期 | 品質 LoRA |

### 決策流程圖

```
需要使用 LoRA 權重排程?
        │
        ├─→ 是角色/姿勢 LoRA?
        │   └─→ [1.0:0.6:0.2-0.3]
        │       早期高權重確立特徵
        │
        ├─→ 是服裝/細節 LoRA?
        │   └─→ [0.7:0.9:0.5]
        │       中期強化細節
        │
        ├─→ 是風格 LoRA?
        │   └─→ [0.4:0.7:0.4-0.5]
        │       中後期統一風格
        │
        ├─→ 是背景/光影 LoRA?
        │   └─→ [0.3:0.6:0.6-0.7]
        │       後期補充
        │
        └─→ 多個角色 LoRA?
            └─→ 交錯峰值
                主角: [1.0:0.7:0.3]
                配角: [0.7:1.0:0.3]
```

---

## 實戰組合範例

### 範例 1: 單人全身像

```
# 最佳實踐
<lora:character:[1.0:0.6:0.3]>        # 角色特徵
<lora:outfit_detail:[0.7:0.9:0.5]>    # 服裝細節
<lora:style:[0.4:0.6:0.5]>            # 整體風格
1girl, character_name, detailed outfit, beautiful scene
```

### 範例 2: 雙人互動

```
ATTN() <lora:char_A:[1.0:0.7:0.3]> <lora:dress_A:[0.7:0.8:0.5]> 
1girl, char_A, red dress MASK(0 0.45, 0 1) AND
ATTN() <lora:char_B:[0.7:1.0:0.3]> <lora:dress_B:[0.7:0.8:0.5]> 
1girl, char_B, blue dress MASK(0.55 1, 0 1)
```

### 範例 3: 複雜場景

```
<lora:background_city:[0.3:0.5:0.6]> city, street, buildings AND
ATTN() <lora:main_char:[1.0:0.7:0.3]> 
1girl, detailed, center MASK(0.3 0.7, 0.3 1, 1.3) AND
ATTN() <lora:side_char:[0.6:0.7:0.5]> 
1girl, background, blurred MASK(0.1 0.35, 0.2 0.8, 0.7)
```

---

## 調試技巧

### 技巧 1: A/B 測試

```
# 測試 A: 固定權重
<lora:character:0.8>

# 測試 B: 權重排程
<lora:character:[1.0:0.6:0.3]>

# 比較結果,選擇更自然的
```

### 技巧 2: 漸進調整

```
# Step 1: 基準
<lora:character:[1.0:0.8:0.3]>

# Step 2: 降低結束權重
<lora:character:[1.0:0.6:0.3]>

# Step 3: 調整切換點
<lora:character:[1.0:0.6:0.25]>
```

### 技巧 3: 觀察關鍵幀

使用 ComfyUI 的預覽功能觀察:
- **30% 時**: 構圖是否確立?
- **50% 時**: 細節是否開始豐富?
- **70% 時**: 整體是否自然?

---

## 總結

### 黃金法則

1. **角色 LoRA 前期強化**: `[1.0:0.6:0.3]`
2. **細節 LoRA 後期提升**: `[0.7:0.9:0.5]`
3. **多人交錯峰值**: 避免同時高權重
4. **總權重控制**: 所有 LoRA 權重和 < 3.0
5. **留足自由度**: 結束權重通常 0.5-0.7

### 實戰建議

- 從標準設定開始: `[1.0:0.6:0.3]`
- 觀察結果後微調
- 記錄有效的配置
- 不同 LoRA 類型使用不同策略

---

**記住**: 權重排程不是萬能的,有時固定權重效果更好。根據實際結果靈活調整!
