# 經貿透視 - 表格處理工作流程

## 工作流程概述

### 主要功能
- 智能識別和拆分表格文檔（T0-T9）
- AI 驅動的表格格式校正
- 複雜格式規則自動化處理
- 內容清理和標準化

### 流程架構
```
Google Drive Trigger → AI 內容分析 → 表格分類 → 格式校正 → 內容處理 → 最終輸出
```

## 表格類型與拆分規則

### 標準表格類型
- **T0**: 國家基本相關資訊
- **T1**: 十年來總體經濟指標
- **T2**: 主要進口產品
- **T3**: 主要出口產品
- **T4**: 主要進口國家
- **T5**: 主要出口國家
- **T6**: 我國自XX進口主要產品
- **T7**: 我國對XX出口主要產品
- **T8**: 重要商展
- **T9**: 商旅資訊表

### 識別邏輯
```javascript
// 表格識別模式
const tablePatterns = {
  'T0': /國家基本相關資訊/,
  'T1': /十年來總體經濟指標/,
  'T2': /主要進口產品?/,
  'T3': /主要出口產品/,
  'T4': /主要進口國家/,
  'T5': /主要出口國家/,
  'T6': /我國自.*?進口主要產品/,
  'T7': /我國對.*?出口主要產品/,
  'T8': /重要商展/,
  'T9': /商旅資訊表/
};
```

## AI 模型配置

### 推薦模型選擇
- **主處理模型**: DeepSeek V2.5 (成本效益最佳，中文處理優秀)
- **輔助模型**: Gemini 2.0 Flash (複雜結構分析)

### 模型分工策略
```javascript
const modelSelection = {
  // DeepSeek V2.5 - 主要文字內容處理
  textProcessing: 'deepseek-v2.5',
  formatStandardization: 'deepseek-v2.5',
  contentCleaning: 'deepseek-v2.5',
  
  // Gemini 2.0 Flash - 複雜結構分析
  structureAnalysis: 'gemini-2.0-flash',
  complexLogic: 'gemini-2.0-flash'
};
```

## 表格格式校正規則

### 1. 國名格式處理
- **中文國名**: 微軟正黑體（加粗）40級
- **英文國名**: Arial 16級

### 2. 表格框線設定
- **內框線**: 細線 (0.5pt)
- **外框線**: 粗線 (1.5pt)
- **顏色**: 黑色 (#000000)

### 3. 表頭格式
- **背景顏色**: R204, G255, B204
- **文字對齊**: 置中
- **字體**: 微軟正黑體（加粗）

### 4. 內容對齊規則
- **表格標題、單位**: 左對齊
- **儲存格內容**: 置中
- **數字**: 右對齊
- **小數點**: 小數點對齊，不足補0

### 5. 特殊格式要求
- **HS Code**: 統一格式
- **年份表示**: 使用全形波浪號「～」
- **百分比**: 半形「%」
- **括號**: 使用半形「()」
- **中文分號**: 使用全形「；」
- **金額格式**: 千分位逗號，如「1,000,000美元」

### 6. 表格寬度
- **統一設定**: 自動調整成視窗大小

## 核心 AI Prompt 設計

### 表格結構分析 Prompt
```
你是專業的表格分析助手，請分析以下表格內容：

分析要求：
1. 識別表格類型（T0-T9中的哪一種）
2. 檢測表格結構和數據類型
3. 識別需要處理的格式問題
4. 標記需要清理的內容

重要提醒：
- 保持所有中文專業術語不變
- 不要進行任何翻譯或轉換
- 以JSON格式回傳分析結果

表格內容：${tableContent}
```

### 格式校正主 Prompt
```
你是專業的表格格式校正助手，請按照經貿透視標準處理以下表格：

=== 校正基準 ===

1. 【國名格式】
   - 中文國名：微軟正黑體（加粗）40級
   - 英文國名：Arial 16級

2. 【表格框線】
   - 內細（0.5pt）外粗（1.5pt）

3. 【表頭設定】
   - 背景色：R204，G255，B204
   - 文字置中對齊

4. 【對齊規則】
   - 標題、單位：左對齊
   - 第一列表頭：置中
   - 數字：右對齊（小數點對齊，不足補0）

5. 【格式標準化】
   - 統一「HS Code」格式
   - 年份間用全形「～」：2019～2020年
   - 金額加千分位：1,000,000美元
   - 百分比用半形「%」
   - 括號用半形「()」
   - 中文分號用全形「；」

6. 【特殊處理】
   - 表格寬度：自動調整成視窗大小
   - T1表格：僅保留近十年數據

當前表格：${tableContent}
表格類型：${tableType}

請直接進行校正，不要解釋過程。
```

### 內容清理專用 Prompt
```
請處理表格中的標準文字清理：

=== 清理規則 ===

針對T2-T5表格，如發現以下文字請完整刪除：
1. "一、按H.S.碼或當地海關號列前４碼，依2016年排名前30項順列。"
2. "二、請注意本表數據（進口值）與其他各表所述數據之一致性。"
3. "三、請以美元表示為首選，以當地幣列表者，加註該幣與美元兌換率（須註明時間點或年、季平均匯率）。"
4. "四、為統一本書刊上傳網路格式架構，請依本標準表格填寫，勿擅改格式。"

針對T1表格：
- 只保留近十年的數據，其餘刪除

針對所有表格：
- 刪除紅色提示文字
- 清理多餘的格式說明
- 保持核心數據完整

當前表格類型：${tableType}
表格內容：${tableContent}

請進行清理並回傳處理後的內容。
```

### 商旅資訊表專用 Prompt
```
請處理商旅資訊表格的特殊校正需求：

=== 商旅資訊表校正基準 ===

1. 【結構標準化】
表格標準欄位：
- 駐外單位名稱
- 貨幣名稱
- 匯率
- 與臺時差
- 網路（撥號、用戶號碼）
- 計程車
- 其他交通工具
- 當地報警電話
- 電話直台灣
- 電話直台灣地
- 行動電話
- 信用卡客服專線
- 旅遊水位查詢
- 小費
- 商店營業時間
- 檢疫規定
- 建議旅遊地名
- 建議旅館或民宿

2. 【內容清理】
刪除所有提示文字：
- "(請查詢後填入)"
- "(請聯絡後補充)"
- 任何紅色標記文字

3. 【格式統一】
- 電話格式：+國碼-區碼-號碼
- 時差格式：±X小時
- 幣別：使用標準ISO代碼

4. 【專業術語保護】
以下術語必須保持原樣：
- 駐外單位名稱
- 當地報警電話
- 電話直台灣
- 信用卡客服專線
- 旅遊水位查詢

表格內容：${tableContent}
請按照上述標準進行校正。
```

### 數字格式處理 Prompt
```
請處理表格中的數字格式標準化：

=== 數字格式規則 ===

1. 【對齊方式】
   - 整數：右對齊
   - 小數：小數點對齊
   - 不足位數：自動補0

2. 【千分位處理】
   - 大於1000的數字：加逗號分隔
   - 金額格式：1,000,000美元

3. 【百分比格式】
   - 使用半形「%」
   - 小數位數統一

4. 【特殊數字】
   - 年份：保持4位數格式
   - 代碼：保持原始格式

表格數據：${tableData}
請回傳格式化後的數據。
```

## n8n 工作流程節點

### 主要節點序列
1. **Google Drive Trigger** - 監控表格上傳
2. **Google Docs (Get Content)** - 讀取表格內容
3. **AI Agent (Structure Analysis)** - 表格結構分析
4. **Function Node (Type Detection)** - 表格類型判斷
5. **Switch Node** - 根據類型分支處理
6. **AI Agent (Format Correction)** - 格式校正
7. **AI Agent (Content Cleaning)** - 內容清理
8. **Function Node (Number Formatting)** - 數字格式化
9. **Google Docs (Update Table)** - 更新表格
10. **Google Docs (Apply Formatting)** - 套用最終格式

### 關鍵設定參數

#### 表格樣式 JSON
```json
{
  "tableStyle": {
    "borderStyle": {
      "inner": {
        "width": {"magnitude": 0.5, "unit": "PT"},
        "color": {"rgbColor": {"red": 0, "green": 0, "blue": 0}}
      },
      "outer": {
        "width": {"magnitude": 1.5, "unit": "PT"}, 
        "color": {"rgbColor": {"red": 0, "green": 0, "blue": 0}}
      }
    },
    "headerStyle": {
      "backgroundColor": {
        "rgbColor": {"red": 0.8, "green": 1, "blue": 0.8}
      }
    }
  }
}
```

#### 文字樣式 JSON
```json
{
  "chineseCountryName": {
    "fontFamily": "Microsoft JhengHei",
    "fontSize": {"magnitude": 40, "unit": "PT"},
    "bold": true
  },
  "englishCountryName": {
    "fontFamily": "Arial",
    "fontSize": {"magnitude": 16, "unit": "PT"}
  }
}
```

## 專業術語保護機制

### 保護清單
```javascript
const protectedTerms = [
  '駐外單位名稱', '貨幣名稱', '匯率', 
  '與臺時差', '當地報警電話',
  '電話直台灣', '信用卡客服專線', 
  '旅遊水位查詢', '商店營業時間',
  '檢疫規定', '主要進口產品',
  '主要出口產品', '重要商展'
];
```

### 驗證機制
```javascript
function validateTerms(beforeContent, afterContent) {
  return protectedTerms.every(term => 
    beforeContent.includes(term) === afterContent.includes(term)
  );
}
```

## 執行監控與品質控制

### 品質檢查項目
1. 表格類型識別準確性
2. 格式校正完整性
3. 專業術語保持不變
4. 數字格式標準化效果
5. 內容清理徹底性

### 錯誤處理
- AI 回應驗證機制
- 格式套用失敗重試
- 內容備份與恢復
- 異常情況日誌記錄

### 效能優化
- 批量處理策略
- AI 調用頻率控制
- 快取機制利用
- 資源使用監控

## 成本控制策略

### DeepSeek V2.5 優勢
- 成本極低（約為 GPT-4 的 1/20）
- 中文處理優秀，避免翻譯誤差
- 批量處理適合大量表格校正

### 使用建議
- 優先使用 DeepSeek 進行主要處理
- 僅在複雜邏輯時調用 Gemini
- 設定每日 API 調用上限
- 監控成本使用情況
